require "test_helper"
require "pry"
class HDRHistogramTest < Minitest::Test
  def test_that_it_has_a_version_number
    refute_nil ::HDRHistogram::VERSION
  end

  def test_hdr_correct_record
    hdr = HDRHistogram.new(0.001,1000, 3, multiplier: 0.001)
    successful_responses = 1000
    expected_time = 0.01

    successful_responses.times { hdr.record(expected_time) }
    hdr.record_corrected((successful_responses * expected_time), expected_time)
    assert_equal hdr.percentile(10), 0.01
    assert_equal hdr.percentile(50), 0.01
    assert_equal hdr.percentile(75), 5.003
    assert_equal hdr.percentile(90), 8.003
    assert_equal hdr.percentile(99), 9.807
    assert_equal hdr.percentile(100), 10.007
  end
  
  def test_hdr_unserialize
    str = "1 10000000 0 3 10 1024 2047 2048 14 118 14712 0 1.000000 15360 240000 [~118 1 0 1 ~7 1 ~8 1 ~8 1 ~7 1 ~10 1 ~7 1 0 1 ~4 !3 ~2 !3 ~3 2 !2 ~3 2 0 2 0 !2 0 1 2 !2 0 1 2 1 2 0 1 0 1 0 !3 3 !6 0 !3 2 1 2 !2 2 1 0 !2 4 1 3 ~2 #2 0 2 0 #2 2 ~2 !2 0 2 4 2 1 0 @2 3 @3 3 2 1 2 #2 !2 2 4 1 3 1 5 !2 0 2 5 @2 !2 #4 5 0 2 5 1 $2 2 4 1 5 1 #5 4 1 #2 1 5 0 5 3 1 4 3 1 3 2 1 8 !2 #2 2 1 4 6 5 1 2 8 1 2 3 5 2 #2 2 3 6 2 3 6 5 3 !2 6 0 7 %2 2 0 5 4 8 2 4 1 7 $2 3 8 @2 4 7 4 3 6 @2 7 6 2 3 4 5 3 6 4 2 %2 4 %2 $2 3 5 6 #2 7 3 ^2 5 4 2 %3 3 4 1 8 4 5 4 8 5 4 2 3 10 %2 3 7 9 4 2 7 5 2 6 9 $2 7 5 2 5 8 6 7 3 5 2 7 6 %2 6 8 4 1 8 6 4 *2 1 %2 7 10 7 4 3 7 5 *2 4 6 8 4 &2 10 6 5 9 7 *2 6 7 8 6 9 10 5 10 5 8 10 8 6 8 5 9 8 9 6 10 9 9 8 5 7 11 7 4 16 10 6 10 6 5 14 14 %2 11 5 13 7 8 11 7 10 9 11 *2 4 11 9 8 10 5 10 7 10 10 7 12 6 11 5 9 5 7 10 9 11 7 4 15 10 8 5 13 7 10 13 &3 15 10 5 12 10 4 10 12 14 5 13 11 2 8 15 9 7 12 12 3 11 9 10 8 10 12 10 13 8 7 13 14 9 11 11 7 18 10 7 11 9 13 10 9 8 15 11 10 9 12 8 12 12 10 8 12 11 10 15 12 8 11 10 10 15 11 10 11 14 7 5 11 20 11 10 12 16 11 10 10 15 13 11 10 12 12 10 17 11 12 15 10 10 16 9 17 12 14 11 10 12 16 9 16 14 7 13 11 11 13 12 15 10 13 15 11 9 11 16 15 11 10 16 12 13 14 14 14 8 21 8 13 18 13 14 14 18 14 9 23 12 11 15 11 16 19 15 12 15 15 19 14 10 17 15 19 14 12 17 15 13 16 17 15 17 13 15 13 19 9 19 13 16 9 20 13 14 17 13 19 8 20 18 9 14 16 20 12 14 9 22 13 17 13 18 12 18 19 17 10 18 20 15 13 19 16 17 11 27 9 14 21 22 10 11 21 18 15 12 25 16 18 12 20 14 20 18 12 15 21 16 15 20 17 20 18 20 14 22 22 13 19 22 24 15 21 23 19 15 33 15 14 20 24 17 14 23 23 16 19 21 18 23 18 25 15 20 23 19 22 15 21 19 20 22 21 19 18 18 22 25 14 20 18 25 20 16 21 23 21 18 25 15 14 22 26 13 21 28 19 22 16 23 22 16 23 25 15 19 25 19 20 24 22 24 22 22 18 30 25 14 31 22 26 17 25 21 27 20 28 17 24 25 21 27 23 22 26 25 19 20 28 18 27 25 19 21 32 21 21 23 31 24 15 27 27 21 29 21 25 21 26 27 24 25 23 24 22 32 21 19 31 28 22 22 23 21 28 36 26 24 19 29 22 27 24 21 27 23 29 23 26 23 25 28 31 22 29 21 25 27 27 24 32 24 23 29 25 16 39 30 26 19 35 23 23 28 36 22 30 23 27 32 23 31 29 21 34 27 23 24 38 26 32 27 33 25 29 35 29 30 29 32 22 42 29 27 29 37 28 27 37 27 29 36 33 25 32 34 27 44 30 35 26 41 31 26 37 33 26 40 37 32 22 40 39 23 34 40 33 34 38 34 30 41 31 38 33 43 32 29 49 23 42 39 44 28 42 34 37 29 43 40 34 41 33 48 29 37 31 49 32 38 29 46 36 39 33 31 38 34 43 35 33 43 40 36 43 40 29 46 36 39 29 44 42 35 40 45 35 38 32 45 42 42 38 35 41 40 42 36 38 37 38 48 32 42 39 35 43 44 34 36 36 48 34 43 35 44 41 45 36 39 34 46 35 46 32 44 40 37 45 42 41 46 40 44 36 41 41 45 34 46 52 38 38 41 51 40 38 42 37 47 45 39 42 33 48 44 39 39 42 46 35 44 40 47 38 41 39 41 41 37 46 38 33 45 44 47 45 38 42 45 53 37 47 43 46 39 47 43 43 38 44 45 46 42 38 50 43 39 40 48 48 35 44 44 50 41 42 46 42 47 52 38 38 55 48 34 51 44 46 42 56 37 42 48 56 37 40 54 46 37 52 51 40 44 52 46 43 49 53 39 47 51 48 41 56 58 46 34 65 48 54 38 60 46 41 44 57 48 50 45 46 55 50 50 44 51 43 51 55 46 43 52 51 31 51 66 38 41 60 47 34 56 67 38 33 57 58 44 47 43 49 50 45 55 45 51 47 55 41 55 47 52 50 53 51 40 50 49 54 46 46 58 51 50 40 71 35 44 66 51 47 52 60 42 48 60 52 60 48 58 43 61 42 64 55 46 53 63 50 45 62 50 53 39 62 53 51 58 47 51 52 51 58 46 53 50 66 48 48 50 57 50 57 53 55 60 52 56 53 60 46 64 52 51 58 55 62 47 51 61 60 59 48 55 51 68 47 57 62 58 49 66 56 55 44 66 51 56 61 46 52 66 54 57 59 53 52 59 54 53 49 53 65 54 41 67 62 42 63 59 56 50 55 58 54 42 68 53 60 53 57 44 59 54 57 53 50 56 58 52 65 44 55 61 56 52 54 55 58 53 51 55 48 69 58 47 55 61 56 50 68 52 56 54 58 53 67 48 59 53 59 48 62 65 53 49 63 66 46 50 63 58 67 56 61 54 55 62 54 63 49 61 60 56 61 58 59 61 58 66 56 62 59 63 53 61 62 54 66 56 61 58 69 53 60 63 64 66 49 62 63 58 44 75 59 58 62 71 58 61 63 62 60 64 60 56 64 65 62 53 77 65 43 69 65 65 54 60 61 59 56 68 60 66 47 69 64 55 59 71 54 52 77 61 59 68 56 63 53 67 70 58 58 50 67 76 48 61 64 65 68 58 57 68 67 61 66 54 71 66 61 59 57 66 69 55 60 75 56 63 71 59 65 63 60 55 63 77 58 55 73 61 55 57 75 62 55 67 65 59 66 73 57 67 63 63 56 74 63 64 68 51 67 80 63 59 66 69 61 74 67 63 56 72 75 52 66 77 56 65 62 69 58 67 77 60 67 68 64 53 77 61 53 66 77 63 57 65 73 59 68 63 71 56 72 66 64 64 71 69 56 66 62 66 71 62 74 53 66 63 69 54 81 60 59 60 75 58 70 64 60 58 75 60 61 61 63 62 66 52 64 73 67 54 56 67 63 61 57 68 68 63 70 49 65 62 72 52 62 67 55 65 64 72 56 68 63 47 59 78 59 48 70 67 53 52 69 68 53 70 56 61 52 73 56 60 63 61 60 64 56 54 68 62 67 48 72 58 61 67 51 58 65 64 59 48 63 65 57 64 60 55 67 52 55 58 63 58 53 57 61 54 66 56 47 67 54 58 55 63 49 56 57 60 59 54 61 67 63 41 52 73 55 55 54 66 54 57 53 56 61 62 50 58 56 44 69 63 50 47 62 67 45 48 74 53 56 55 60 57 44 54 63 58 46 67 51 60 54 53 56 64 51 52 57 54 49 68 43 51 52 69 54 43 55 54 58 42 63 50 52 43 64 50 51 55 58 46 40 67 48 41 50 64 53 42 46 56 51 48 45 58 51 40 61 49 38 55 60 37 48 48 61 37 52 58 43 45 63 40 48 52 50 36 58 35 54 49 48 50 51 43 54 40 53 44 48 50 48 53 41 49 49 45 40 49 48 47 44 44 53 44 36 56 42 40 47 50 47 41 44 41 58 44 41 46 55 33 41 42 54 41 36 58 38 43 44 51 39 37 50 43 47 50 45 43 47 38 46 45 40 54 36 40 40 50 35 38 50 46 36 45 44 40 36 52 38 44 39 46 47 36 35 46 50 40 39 45 43 41 50 45 28 49 40 41 65 88 69 78 73 84 76 75 78 77 75 77 80 75 74 82 68 72 73 81 67 77 77 76 69 69 72 69 75 62 71 67 68 69 66 69 60 74 59 67 69 62 64 63 68 64 68 65 67 68 55 66 57 71 64 61 60 63 58 50 70 52 61 66 53 65 53 64 63 53 68 59 63 59 63 55 60 53 60 59 53 62 54 64 55 59 52 57 53 57 59 49 56 58 52 60 53 59 51 58 55 54 72 44 60 50 57 55 55 56 53 57 53 57 57 56 57 51 60 50 56 58 48 57 56 56 63 46 55 52 60 48 55 48 54 54 45 54 44 56 51 48 46 54 42 52 59 37 51 49 52 49 44 53 49 47 49 44 50 52 53 41 49 50 38 54 46 48 48 42 43 43 43 52 39 41 43 41 47 42 44 46 41 56 34 51 45 41 44 42 44 45 39 53 37 47 38 49 48 39 50 42 41 44 41 40 37 47 39 43 45 36 45 34 48 35 44 40 37 41 40 36 48 35 45 35 37 47 39 41 45 33 45 28 53 35 46 35 40 37 39 39 39 36 44 33 47 31 39 37 38 43 36 41 36 39 37 41 36 45 33 46 34 37 40 35 41 31 38 41 33 41 39 33 38 37 36 40 33 44 29 41 30 32 44 23 47 31 44 33 40 36 42 38 43 35 41 37 39 43 31 42 30 41 39 34 41 38 35 44 33 40 35 34 35 35 36 32 35 32 36 30 39 35 31 32 37 37 34 40 26 37 31 40 29 43 35 35 36 36 36 40 33 35 33 37 36 38 40 34 41 37 30 37 33 39 36 36 32 38 39 30 31 36 34 41 35 33 33 33 31 35 39 38 35 36 34 42 30 40 37 25 43 33 39 38 33 40 30 39 39 32 31 38 31 40 25 42 36 29 43 27 35 33 32 35 30 39 31 30 35 34 35 37 30 44 32 39 36 34 35 36 38 35 36 39 31 35 35 37 39 30 39 33 42 40 29 46 26 40 40 36 38 35 32 46 30 35 34 38 35 36 35 33 40 40 30 45 35 36 36 38 39 37 39 34 41 39 36 41 36 37 42 38 34 42 35 36 37 39 37 36 43 33 40 39 42 33 37 41 34 37 36 45 37 36 42 35 38 38 36 45 34 35 46 33 36 35 39 39 36 36 40 37 42 36 43 33 40 40 35 40 37 31 43 28 42 41 32 51 32 39 40 40 42 43 32 44 35 42 36 42 40 41 41 40 45 40 44 37 44 43 40 42 41 47 39 44 48 44 41 40 46 42 41 47 43 46 33 51 43 49 46 41 45 43 46 44 46 45 37 50 38 51 39 44 45 39 49 41 49 49 36 55 36 54 41 49 44 50 46 47 53 41 49 44 48 44 48 51 43 52 43 47 43 47 57 50 44 46 46 60 45 53 43 48 57 41 59 47 51 49 49 57 44 54 55 44 56 48 58 51 54 49 54 49 53 55 55 52 56 47 55 50 53 51 45 54 50 50 56 42 58 45 54 42 57 53 50 54 49 52 54 48 55 49 49 60 44 56 41 55 48 50 53 52 50 49 45 49 52 49 56 48 55 57 49 54 44 54 54 52 53 52 52 57 48 60 50 52 50 52 52 52 46 56 53 54 51 59 48 56 55 44 57 48 54 54 50 65 46 66 50 59 57 58 50 63 57 52 67 51 70 48 62 59 47 66 55 61 58 56 60 52 61 53 58 64 48 61 62 47 60 53 62 54 52 64 54 63 50 57 59 54 73 50 57 58 57 60 56 55 61 66 57 60 55 60 58 58 63 58 60 59 60 58 60 55 65 50 68 56 64 58 54 57 70 57 66 59 55 68 60 58 70 61 65 58 64 64 52 70 63 69 53 64 61 70 56 70 60 59 70 62 64 61 63 74 63 71 57 67 67 58 77 53 76 58 66 60 61 67 61 59 62 59 58 67 55 61 62 52 61 61 56 63 46 72 57 55 64 57 58 70 51 66 54 58 71 55 54 70 53 57 67 51 71 54 56 64 59 58 62 58 59 59 65 54 62 61 70 59 68 61 55 66 54 64 57 60 64 61 55 56 66 59 59 59 60 65 52 57 55 59 60 55 62 49 60 58 59 52 56 61 55 66 48 69 50 60 56 55 70 49 66 55 70 53 64 58 67 63 53 60 61 57 60 64 52 64 58 51 66 50 62 50 61 57 60 58 63 53 68 54 67 55 59 62 55 60 63 52 62 64 57 66 57 57 66 52 68 61 67 62 60 58 64 60 67 67 54 69 59 62 61 61 64 57 74 56 59 64 56 68 60 58 63 54 68 56 64 65 59 66 132 121 126 118 125 121 123 125 126 124 130 120 127 122 133 119 119 118 124 117 121 128 126 130 114 123 130 115 123 117 126 126 126 121 117 128 131 123 116 121 117 123 109 114 122 118 111 116 119 127 123 113 120 117 122 125 121 114 116 113 121 114 115 131 122 122 116 121 125 123 115 127 117 119 139 122 128 131 134 133 127 142 139 132 127 138 138 132 142 139 128 137 135 144 134 138 132 136 142 128 145 137 150 137 147 143 139 145 159 151 151 158 155 148 162 163 167 153 164 156 157 144 158 155 155 150 146 152 149 141 150 159 148 153 151 155 154 157 160 161 161 158 156 166 163 159 163 165 167 169 169 184 170 170 169 178 172 172 180 170 169 182 169 181 182 172 168 192 181 163 188 179 190 182 195 179 188 192 183 195 175 178 186 196 184 187 193 191 187 189 191 205 192 198 194 197 204 205 193 202 208 197 201 191 204 197 199 214 206 201 212 211 220 209 204 209 203 210 216 200 219 221 218 212 209 208 217 215 202 195 224 221 223 222 240 223 227 226 225 233 230 223 232 226 246 230 226 234 242 239 235 244 234 238 237 243 234 243 238 234 239 239 247 241 245 254 244 247 254 244 261 249 250 251 243 246 244 256 250 243 243 229 249 240 249 231 245 250 240 243 243 242 240 240 235 239 245 233 234 231 246 233 222 226 225 232 223 236 232 220 232 232 231 238 241 240 244 237 232 250 241 237 238 249 236 242 245 252 239 245 238 240 241 241 239 238 236 245 229 229 238 228 244 245 234 224 229 235 230 238 224 230 233 226 230 229 232 240 221 239 223 231 236 221 227 224 221 240 212 218 227 222 215 213 215 237 208 226 207 205 219 211 211 219 209 208 215 219 221 203 212 211 218 212 202 201 198 206 199 195 202 205 199 196 198 192 203 200 200 202 200 199 206 197 190 201 197 193 208 191 193 191 196 197 191 192 192 185 191 176 175 169 179 179 162 169 166 162 166 163 159 164 155 151 152 156 155 159 162 146 158 152 149 150 132 150 142 142 143 134 139 135 139 138 131 123 137 117 129 122 122 125 117 113 115 113 115 115 110 112 119 109 115 108 110 114 113 119 113 111 122 112 109 113 109 111 101 111 105 106 100 110 106 107 104 101 101 100 101 102 100 104 107 103 100 105 104 100 98 101 102 93 100 87 88 90 92 81 85 85 84 85 85 76 93 94 85 82 89 84 83 86 80 80 80 80 84 81 86 79 77 77 84 77 76 75 78 79 81 73 79 74 78 77 75 78 70 75 77 71 68 69 68 67 64 70 63 60 63 68 67 68 61 62 62 65 66 64 63 61 63 72 62 68 62 64 57 64 59 57 60 62 58 63 53 62 58 60 55 56 59 52 52 53 55 54 59 53 48 53 53 55 54 53 51 54 58 52 55 48 49 53 51 47 51 50 52 47 43 47 48 41 46 45 52 46 46 48 44 49 48 49 46 46 47 48 48 46 45 45 41 48 43 41 44 46 38 42 42 39 38 44 40 43 36 42 47 40 37 41 42 36 44 37 37 40 35 33 35 43 32 39 33 36 34 36 38 31 38 34 34 36 37 33 35 34 33 40 36 35 30 35 34 29 39 37 31 34 29 33 36 32 33 31 32 36 32 38 34 32 37 35 34 37 37 35 36 36 33 38 30 34 28 38 31 29 32 32 35 31 33 37 39 37 37 35 41 41 34 38 39 39 41 38 34 41 37 42 42 39 46 40 40 42 41 44 46 44 43 45 47 45 39 48 46 39 44 50 49 46 46 46 51 45 48 43 43 46 47 48 47 42 47 51 52 49 49 49 52 53 49 55 45 53 56 48 55 54 50 57 54 52 47 55 48 49 52 46 49 52 50 48 54 54 49 57 54 50 51 55 53 54 50 51 54 54 56 54 51 58 50 57 55 51 55 57 55 53 59 59 59 58 49 64 62 58 60 60 59 66 60 59 63 58 61 65 61 56 63 60 61 59 57 58 54 59 62 57 60 54 58 58 57 60 60 64 62 57 65 64 59 52 61 54 58 61 58 56 57 62 56 64 56 62 56 58 58 58 63 57 53 56 62 57 59 56 54 65 61 61 58 59 56 63 57 57 56 61 62 56 56 56 60 59 56 53 56 53 58 57 54 63 51 56 60 61 56 57 58 59 56 59 57 60 57 58 63 62 55 69 62 65 61 57 61 63 68 64 55 59 54 59 60 60 62 51 58 60 55 55 59 58 54 56 56 53 54 57 54 50 53 54 55 53 53 55 51 49 58 53 58 55 58 50 57 58 57 58 52 60 58 53 54 56 109 103 106 102 104 96 106 98 98 96 97 94 96 87 88 91 75 78 77 69 79 74 75 72 63 70 67 68 67 70 65 66 69 61 62 60 60 55 59 58 52 54 55 55 52 52 53 48 48 53 50 51 48 44 52 43 43 46 41 44 40 44 40 41 38 35 37 36 32 34 31 31 29 29 31 31 27 26 28 25 25 23 21 20 21 21 20 18 18 19 18 18 14 10 12 9 7 9 9 *3 9 ^2 7 6 7 6 8 5 4 8 6 7 4 %2 4 5 $2 5 $2 5 $4 6 $4 1 2 #3 4 5 3 2 #2 @4 3 @5 5 6 7 8 6 &5 5 &2 5 4 6 9 10 9 7 8 11 12 10 10 12 12 10 9 11 12 10 12 11 12 11 10 9 11 10 11 10 11 8 13 8 10 8 10 9 *2 &2 6 7 8 6 9 &2 6 &2 8 &3 6 &3 6 &2 6 9 6 &2 6 7 6 7 %3 $5 5 6 %2 8 6 7 6 5 7 6 8 6 8 ^2 8 6 7 6 &2 6 %2 3 @3 $2 @3 3 @2 3 6 $2 3 2 #4 2 3 1 #2 2 3 2 1 @2 3 !2 2 1 3 0 !2 @3 0 !2 2 ~6 1 ~103 1 2 3 2 3 @2 3 2 1 ~4 @2 3 2 3 @2 3 2 3 @2 3 2 3 @2 3 @2 3 2 3 2 3 @2 3 2 3 @3 3 @2 3 @4 3 @2 3 @5 3 @8 1 2 !2 0 1 ~181 2 3 @2 3 @5 3 @2 3 @2 3 @2 3 @4 3 @5 3 2 3 @3 3 @2 3 @4 3 @3 3 @2 3 @3 3 @4 3 @5 3 @4 3 @4 3 @5 3 @4 3 @4 3 @3 3 @3 3 @2 3 @3 3 2 3 @6 3 1 @3 ~2 1 ~10448 ]"
    assert_raises(HDRHistogram::HDRHistogramError) do
      HDRHistogram.unserialize("banana")
    end
    
    hdr = HDRHistogram.unserialize(str, unit: "ms", multiplier: 0.001)
    
    assert_equal hdr.serialize, str
    #assert_equal(hdr.stats, " 10.000%        0.032ms\n 20.000%        0.045ms\n 30.000%        0.049ms\n 40.000%        0.062ms\n 50.000%        0.089ms\n 60.000%        0.102ms\n 70.000%        0.123ms\n 80.000%        0.136ms\n 90.000%        0.152ms\n100.000%        0.239ms\n")
    
    #binding.pry
    
    assert_equal hdr.count, 240000
    assert_in_epsilon hdr.min, 0.118
    assert_in_epsilon hdr.mean, 4.092
    assert_in_epsilon hdr.percentile(99), 8.727
    assert_in_epsilon hdr.stddev, 2.137
  end

  def test_hdr

  end
end
